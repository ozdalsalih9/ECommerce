@model E_Commerse.Core.Entities.Product
@{
    ViewData["Title"] = "Ürün Ekle";
}

<hr />
<div class="row">
    <div class="col-md-8">
        <form asp-action="Create" enctype="multipart/form-data" id="productForm">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <!-- Temel Ürün Bilgileri -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">Temel Bilgiler</div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label asp-for="Name" class="control-label fw-bold"></label>
                        <input asp-for="Name" class="form-control" required />
                        <span asp-validation-for="Name" class="text-danger"></span>
                    </div>
                    <div class="form-group mb-3">
                        <label asp-for="Description" class="control-label fw-bold"></label>
                        <textarea asp-for="Description" class="form-control" rows="3"></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>
                    <div class="form-group mb-3">
                        <label asp-for="ImageFile" class="control-label fw-bold">Ana Ürün Resmi</label>
                        <input asp-for="ImageFile" class="form-control" type="file" accept="image/*" required />
                        <span asp-validation-for="ImageFile" class="text-danger"></span>
                        <small class="text-muted">Ana ürün resmi (JPEG, PNG formatında, max 5MB)</small>
                    </div>
                    <div class="form-group mb-3">
                        <label class="control-label fw-bold">Ek Ürün Resimleri</label>
                        <input name="Images" class="form-control" type="file" multiple accept="image/*" />
                        <small class="text-muted">Ek ürün resimleri (Birden fazla seçebilirsiniz, max 5MB each)</small>
                    </div>
                </div>
            </div>

            <!-- Fiyat ve Diğer Bilgiler -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">Fiyat ve Diğer Bilgiler</div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="Price" class="control-label fw-bold"></label>
                                <div class="input-group">
                                    <input asp-for="Price" class="form-control" type="number" step="0.01" min="0" required />
                                    <span class="input-group-text">₺</span>
                                </div>
                                <span asp-validation-for="Price" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="ProductCode" class="control-label fw-bold"></label>
                                <input asp-for="ProductCode" class="form-control" required />
                                <span asp-validation-for="ProductCode" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="CategoryId" class="control-label fw-bold"></label>
                                <select asp-for="CategoryId" class="form-select" asp-items="ViewBag.CategoryId" required>
                                    <option value="">-- Kategori Seçin --</option>
                                </select>
                                <span asp-validation-for="CategoryId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="BrandId" class="control-label fw-bold"></label>
                                <select asp-for="BrandId" class="form-select" asp-items="ViewBag.BrandId" required>
                                    <option value="">-- Marka Seçin --</option>
                                </select>
                                <span asp-validation-for="BrandId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="OrderNo" class="control-label fw-bold"></label>
                                <input asp-for="OrderNo" class="form-control" type="number" />
                                <span asp-validation-for="OrderNo" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mt-4 pt-2">
                                <input class="form-check-input" asp-for="IsActive" />
                                <label class="form-check-label fw-bold" asp-for="IsActive"></label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mt-4 pt-2">
                                <input class="form-check-input" asp-for="IsHome" />
                                <label class="form-check-label fw-bold" asp-for="IsHome"></label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Renk Yönetimi -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">Renk Seçenekleri</div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label asp-for="SelectedColorIds" class="control-label fw-bold">Renkler</label>
                        <select asp-for="SelectedColorIds" class="form-select select2" multiple="multiple"
                                asp-items="ViewBag.Colors" required>
                        </select>
                        <span class="text-danger field-validation-valid"
                              data-valmsg-for="SelectedColorIds" data-valmsg-replace="true"></span>
                    </div>

                    <div id="colorImagesContainer">
                        <!-- Dinamik olarak renk resim alanları eklenecek -->
                    </div>
                </div>
            </div>

            <!-- Beden ve Stok Yönetimi -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">Beden ve Stok Bilgileri</div>
                <div class="card-body">
                    <div id="sizeStockContainer">
                        <div class="size-stock-row row mb-2">
                            <div class="col-md-5">
                                <input type="text" name="sizeNames" class="form-control" placeholder="Beden (Örn: S, M, XL)" required />
                            </div>
                            <div class="col-md-5">
                                <input type="number" name="stocks" class="form-control" placeholder="Stok Adedi" min="0" required />
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-danger remove-size-stock" disabled>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="addSizeStock" class="btn btn-sm btn-outline-primary mt-2">
                        <i class="fas fa-plus"></i> Yeni Beden Ekle
                    </button>
                </div>
            </div>

            <div class="form-group mt-3 d-flex justify-content-between">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Ürünü Kaydet
                </button>
                <a asp-action="Index" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Listeye Dön
                </a>
            </div>
        </form>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <i class="fas fa-info-circle"></i> Bilgilendirme
            </div>
            <div class="card-body">
                <h6><i class="fas fa-image text-primary"></i> Resim Yükleme</h6>
                <ul class="small">
                    <li>Ana resim ürün listesinde görünecektir</li>
                    <li>Ek resimler ürün detay sayfasında gösterilir</li>
                    <li>Resimler otomatik olarak optimize edilecektir</li>
                </ul>

                <h6 class="mt-3"><i class="fas fa-palette text-primary"></i> Renk Yönetimi</h6>
                <ul class="small">
                    <li>Birden fazla renk seçebilirsiniz</li>
                    <li>Her renk için ayrı resimler yükleyebilirsiniz</li>
                    <li>Renk resimleri ürün detayında gösterilecektir</li>
                </ul>

                <h6 class="mt-3"><i class="fas fa-boxes text-primary"></i> Stok Yönetimi</h6>
                <ul class="small">
                    <li>Her beden için stok miktarı girmelisiniz</li>
                    <li>Stok miktarı 0 olan ürünler "Stokta Yok" olarak işaretlenir</li>
                </ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/tr.js"></script>

    <script>
        $(document).ready(function() {
            // Select2 ile çoklu seçim
            $('.select2').select2({
                placeholder: "Renk seçin",
                allowClear: true,
                language: "tr"
            });

            // Renk seçimine göre resim yükleme alanlarını oluştur
            $('.select2').on('change', function() {
                updateColorImageFields();
            });

            // Yeni beden-stok satırı ekle
            $('#addSizeStock').click(function() {
                var newRow = $('#sizeStockContainer .size-stock-row').first().clone();
                newRow.find('input').val('');
                newRow.find('.remove-size-stock').prop('disabled', false);
                $('#sizeStockContainer').append(newRow);
            });

            // Beden-stok satırı sil
            $(document).on('click', '.remove-size-stock', function() {
                if ($('#sizeStockContainer .size-stock-row').length > 1) {
                    $(this).closest('.size-stock-row').remove();
                }
                if ($('#sizeStockContainer .size-stock-row').length === 1) {
                    $('#sizeStockContainer .size-stock-row .remove-size-stock').prop('disabled', true);
                }
            });

            // Form gönderilmeden önce validasyon
            $('#productForm').submit(function(e) {
                // Renk seçimi kontrolü
                const selectedColors = $('.select2').val();
                if (!selectedColors || selectedColors.length === 0) {
                    alert('En az bir renk seçmelisiniz!');
                    e.preventDefault();
                    return false;
                }

                // Resim boyutu kontrolü
                const maxSize = 5 * 1024 * 1024; // 5MB
                let isValid = true;

                // Ana resim kontrolü
                const mainImage = $('#ImageFile')[0].files[0];
                if (mainImage && mainImage.size > maxSize) {
                    alert('Ana resim 5MB boyutunu aşamaz!');
                    isValid = false;
                }

                // Ek resimler kontrolü
                const extraImages = $('#ImageFiles')[0].files;
                if (extraImages) {
                    for (let i = 0; i < extraImages.length; i++) {
                        if (extraImages[i].size > maxSize) {
                            alert('Ek resimlerden biri 5MB boyutunu aşıyor!');
                            isValid = false;
                            break;
                        }
                    }
                }

                // Renk resimleri kontrolü
                $('input[type="file"][name^="colorImages"]').each(function() {
                    const files = this.files;
                    if (files && files.length > 0) {
                        for (let i = 0; i < files.length; i++) {
                            if (files[i].size > maxSize) {
                                alert('Renk resimlerinden biri 5MB boyutunu aşıyor!');
                                isValid = false;
                                return false; // break the each loop
                            }
                        }
                    }
                });

                if (!isValid) {
                    e.preventDefault();
                }

                return isValid;
            });

            // Renk resim alanlarını güncelle
            function updateColorImageFields() {
                $('#colorImagesContainer').empty();
                const selectedColors = $('.select2').val();

                if (selectedColors && selectedColors.length > 0) {
                    // Renk bilgilerini al
                    const colors = @Html.Raw(ViewBag.ColorListJson);

                    selectedColors.forEach(colorId => {
                        const color = colors.find(c => c.value == colorId);
                        if (color) {
                            const colorName = color.text;
                            const colorDiv = $(`
                                <div class="color-image-group mb-4" data-color-id="${colorId}">
                                    <h5>${colorName} Resimleri</h5>
                                    <input type="file" name="colorImages[${colorId}]" multiple
                                           class="form-control color-image-input" accept="image/*" />
                                    <div class="preview-container mt-2 row"></div>
                                    <small class="text-muted">Bu renge ait resimleri yükleyin (Birden fazla seçebilirsiniz)</small>
                                </div>
                            `);
                            $('#colorImagesContainer').append(colorDiv);

                            // Resim önizleme için
                            colorDiv.find('.color-image-input').change(function() {
                                const previewContainer = $(this).siblings('.preview-container');
                                previewContainer.empty();

                                if (this.files) {
                                    Array.from(this.files).forEach(file => {
                                        const reader = new FileReader();
                                        reader.onload = function(e) {
                                            previewContainer.append(`
                                                <div class="col-3 mb-2">
                                                    <img src="${e.target.result}" class="img-thumbnail" style="height: 80px; width: 100%; object-fit: cover;" />
                                                </div>
                                            `);
                                        }
                                        reader.readAsDataURL(file);
                                    });
                                }
                            });
                        }
                    });
                }
            }

            // Başlangıçta renk resim alanlarını güncelle
            updateColorImageFields();
        });
    </script>
}